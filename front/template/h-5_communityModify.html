<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <link rel="manifest" href="site.webmanifest"/>
  <link rel="apple-touch-icon" href="icon.png"/>
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="../css/normalize.css"/>
  <link rel="stylesheet" href="../css/main.css"/>
  <link rel="stylesheet" href="../css/reset.css"/>
  <link rel="stylesheet" href="../css/menu.css"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <meta name="theme-color" content="#fafafa"/>
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
  />
  <title>올라 커뮤니티</title>
  <style>
    .container {
      width: 1200px;
      padding: 0;
      margin-bottom: 150px;
    }

    /* 부트스트랩 버튼의 호버, 포커스 기능 빼기 */
    .btn:active,
    .btn:focus,
    .btn:hover {
      outline: none !important;
      /* box-shadow:none !important; */
      background-color: #f46b3f;
      border: 1px solid #f46b3f;
    }

    .cteate-post > label {
      position: absolute;
      top: 17px;
      left: 20px;
      transition: all 0.5s;
      font-size: 16px;
      color: gray;
    }

    .cteate-content > label {
      position: absolute;
      top: 17px;
      left: 20px;
      transition: all 0.5s;
      font-size: 16px;
      color: gray;
    }

    .tag-upload-box > span {
      width: 70px;
      height: 50px;
      font-size: 20px;
      margin: 0;
    }

    .creat-tag > label {
      position: absolute;
      left: 20px;
      transition: all 0.5s;
      font-size: 16px;
      color: gray;
    }

    .creat-tag > input {
      width: 1130px;
      height: 50px;
    }

    .b_10_1 input {
      width: 100px;
      height: 30px;
      border-radius: 5px;
      display: inline-block;
      border: 1px solid #d2d2d2;
      margin-left: 10px;
      top: 30px;
    }

    .chatCnt-input {
      border: 1px solid #d2d2d2;
      border-radius: 5px;
    }

    /* 업로드 파일 css */
    .filebox input[type="file"] {
      position: absolute;
      width: 0;
      height: 0;
      padding: 0;
      overflow: hidden;
      border: 0;
    }

    .w_2,
    .w_4,
    .w_8,
    .w_9 {
      padding: 0px;
      width: 1200px;
      margin-bottom: 20px;
    }

    .w_7 {
      width: 1200px;
      /*height: 400px;*/
    }

    #btn_1 {
      width: 200px;
      height: 50px;
      border: 1px solid white;
      background-color: #f46b3f;
      border-radius: 5px;
      color: white;
      float: right;
    }

    #btn_2,
    #btn_3 {
      width: 100px;
      height: 100%;
      border: 1px solid white;
      color: white;
      background-color: #f46b3f;
      border-radius: 5px;
    }

    .w_3 input,
    .w_4 input,
    .w_5 input {
      width: 350px;
    }

    .w_7 textarea {
      height: 150px;
      resize: none;
    }

    .w_8 input {
      width: 500px;
    }

    .inputLabel {
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-control {
      margin-bottom: 5px;
    }

    #tag-search-input {
      width: 200px;
    }

    .tag-select-box {
      width: 370px;
      height: 200px;
      padding: 20px 20px 0;
      overflow: scroll;
      background-color: white;
      border: 1px solid #ced4da;
      border-radius: 5px;
      margin-top: 10px;
    }

    .tag-select-box .item {
      width: 100%;
      margin-bottom: 10px;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- ############# 네비게이션 #############-->
<header class="menu">
  <div class="bg-line"></div>
  <div class="logo-wrap" style="cursor: pointer;" onclick="moveMainPage()">
    <img class="img" src="./../static/img/logo_main.png" alt="로고"/>
  </div>
  <div class="item-list">
    <a href="./g-1_recommend.html">코스추천</a>
    <a href="h-1_communityMain.html" style="font-weight: bold; color: #f46b3f">커뮤니티</a>
    <a href="./i-1_shopMain.html">쇼핑몰</a>
    <a href="./j-1_noticeMain.html">공지사항</a>
  </div>
  <div class="right"></div>
</header>

<!-- ############# 작업공간 #############-->
<!-- 메인 컨테이너 -->
<main class="container">
  <h3 style="margin: 30px 0; font-weight: bold">커뮤니티 수정</h3>
  <section>
    <p class="inputLabel">제목</p>
    <div class="w_2">
      <input
          type="text"
          class="form-control"
          id="title"
          placeholder="제목을 입력하세요"
      />
    </div>
    <p class="inputLabel">내용</p>
    <div class="w_7">
                    <textarea
                        class="form-control"
                        id="contents"
                        rows="3"
                        placeholder="내용을 입력하세요"
                    ></textarea>
    </div>
    <div class="w_8" style="margin-top: 30px">
      <!--      <input-->
      <!--          class="form-control"-->
      <!--          type="file"-->
      <!--          id="formFileMultiple"-->
      <!--          multiple-->
      <!--      />-->
      <form method="post" enctype="multipart/form-data">
        <input
            type="file"
            id="chooseFile"
            class="form-control"
            name="chooseFile"
            accept="image/*"
            multiple
            onchange="imgPresignedURL()"
        />
      </form>
      <div id="img-wrap" style="display: flex; gap: 5px">
        <!-- 이미지 들어가는 자리 -->
      </div>
    </div>
    <div style="display: flex; height: 35px; align-items: center; margin-top: 20px">
      <p class="inputLabel" style="margin-right: 20px">태그</p>
      <input
          type="text"
          class="form-control"
          id="tag-search-input"
          style="height: 100%; margin-right: 10px; margin-bottom: 0"
          placeholder="태그를 입력하세요"
      />
      <button id="btn_2" type="button" onclick="searchTags()">검색</button>
      <div id="tag-select-list" style="display: flex; margin-left: 20px"></div>
      <p
          style="
                            margin: 0;
                            font-size: 12px;
                            font-weight: bold;
                            color: #f46b3f;
                            margin-left: 10px;
                            cursor: pointer;
                        "
          onclick="removeTag()"
      >
        전체 지우기
      </p>
    </div>
    <ul class="tag-select-box">
      <!--      <li class="item">봄산</li>-->
      <!--      <li class="item">봄산</li>-->
      <!--      <li class="item">봄산</li>-->
    </ul>
    <!--    <div id="tag-wrap" class="w_4">-->
    <!--      <input-->
    <!--          type="text"-->
    <!--          class="form-control"-->
    <!--          placeholder="태그를 입력하세요"-->
    <!--      />-->
    <!--    </div>-->

    <p class="inputLabel" style="margin-right: 20px">태그 직접 추가</p>
    <div style="display: flex">
      <input
          type="text"
          class="form-control"
          id="tag-add"
          style="width: 250px; height: 100%; margin-right: 10px; margin-bottom: 0"
          placeholder="태그를 입력하세요"
      />
      <button id="btn_3" type="button" onclick="addTag()">추가</button>
    </div>
    <div class="form-check" style="margin-top: 40px">
      <input
          class="form-check-input"
          type="checkbox"
          value="Y"
          id="flexCheckDefault"
          onchange="checkChat()"
      />
      <label class="form-check-label" for="flexCheckDefault"> 크루원 구하기 </label>
      <p style="font-size: 12px; font-weight: bold">
        참여 인원 :
        <input
            class="chatCnt-input"
            type="number"
            max="10"
            min="0"
            id="chatCnt-input"
            style="width: 50px"
            placeholder="0"
        />명 (※최소 인원 2명/최대 인원 10명)
      </p>
    </div>

    <div class="w_9">
      <div class="b_1">
        <button type="button" id="btn_1" onclick="updateCommunity()">
          게시글 수정
        </button>
      </div>
    </div>
  </section>
</main>
<script>
  // 파일 업로드 스크립트 설정
  $("#file").on("change", function () {
    var fileName = $("#file").val()
    $(".upload-name").val(fileName)
  })

  $(".form-check-input").on("click", function () {
    var checked = $(".form-check-input").is(":checked")

    if (checked) {
      $(".chatCnt-input").attr("disabled", false)
      $(".chatCnt-input").focus()
    } else {
      $(".chatCnt-input").val("0")
      $(".chatCnt-input").attr("disabled", true)
      $("#flexCheckDefault").val("N")
    }
  })
</script>
<script>
  var communityId = localStorage.getItem("communityId")
  var accessToken = localStorage.getItem("accessToken")
  var imageUrlList = []
  var tags = []
  var isChat = false

  $(document).ready(function () {
    checkLogin();
    getMenuProfile()
    getCommunity()
    searchTags()
    myFriedList();
    recommendFriedList();
    selectAlarm();
    $(".friend-dropbox").hide()
    $(".bell-dropbox").hide()
  })

  function checkLogin(){
    const nickname = localStorage.getItem("nickname")

    if(nickname!=null){
      const result = `<div class="friend">
                                <div class="icon-friend" onclick="handleToggleFriendDropBox()">
                                    <img class="img" src="./../static/img/icon_friends.png"/>
                                </div>
                                <div class="friend-dropbox">
                                    <div class="search-area">
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="searchNickName" placeholder="닉네임 검색"
                                                   style="width: 240px; height: 40px">
                                        </div>
                                        <div class="btn-wrap">
                                            <button type="button" class="btn btn-primary search-btn" onclick="searchFriend()"
                                                    style="height: 40px;">검색
                                            </button>
                                        </div>
                                    </div>

                                    <div class="friend-div">
                                        <ul class="friend-list-3"></ul>


                                        <ul class="friend-list-1">
                                            <p class="recommend-title">내 친구목록</p>
                                        </ul>

                                        <div class="line"></div>

                                        <ul class="friend-list-2">
                                            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="bell">
                                <div class="icon-bell" onclick="handleToggleBellDropBox()">
                                    <img class="img" src="./../static/img/icon_bell.png"/>
                                </div>
                                <div class="bell-dropbox">
                                    <p style="margin-bottom: 10px">알람</p>
                                    <ul id="alarm">

                                    </ul>
                                </div>
                            </div>
                            <a id="my-profile" style="display: flex; align-items: center;" class="my-profile-wrap"
                               href="./f-1_myPage.html">
                            </a>`;

      $(".right").append(result);
    }else{
      const result = `<div class="my-profile-wrap">
                                    <div class="img-wrap">
                                        <img class="img" src="./../static/img/icon_profile_default.png " />
                                    </div>
                                    <p class="text">로그인 해주세요</p>
                                </div>`

      $(".right").append(result);
    }
  }
  function getMenuProfile() {
    var menuProfile = JSON.parse(localStorage.getItem("menuProfile"))
    const nickname = localStorage.getItem("nickname")
    var tempProfile = `
                    <div class="img-wrap">
                        <img class="img" style="width: 100%; height: auto" src=${
        menuProfile.profileImage
            ? menuProfile.profileImage
            : "./../static/img/icon_profile_default.png"
    } alt="프로필사진"/>
                    </div>
                    <p class="text">${nickname}님</p>
            `
    $("#my-profile").append(tempProfile)
  }

  function handleToggleBellDropBox() {
    $(".bell-dropbox").toggle()
    $(".friend-dropbox").hide()
  }

  function handleToggleFriendDropBox() {
    $(".friend-dropbox").toggle();
    $(".bell-dropbox").hide();

    //사람버튼 클릭 시 기존 데이터 reload 되도록
    $(".friend-div").empty();

    let result = `<ul class="friend-list-3"></ul>
                              <ul class="friend-list-1">
                                <p class="recommend-title">내 친구목록</p>
                              </ul>

                              <div class="line"></div>

                              <ul class="friend-list-2">
                                <p class="recommend-title" style="margin-top: 10px">추천 친구</p>
                              </ul>`

    $(".friend-div").append(result);
    myFriedList();
    recommendFriedList();
  }

  async function getCommunity() {
    const accessToken = localStorage.getItem("accessToken")
    $.ajax({
      type: "GET",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/boards/communities/" +
          communityId,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: async function (response) {
        console.log("response : ", response)
        // 제목 넣기
        $("#title").attr("value", response.title)

        // 내용 넣기
        $("#contents").val(response.contents)

        // 사진 넣기
        for (let i = 0; i < response.imgList.length; i++) {
          var imgUrl = ""
          if (response.imgList[i]) {
            imgUrl = await getImageURL(response.imgList[i])
          } else {
            imgUrl = "./../static/img/mountain-default.png"
          }
          var temp = `
                                <div style="width: 300px; height: 185px; overflow: hidden; position: relative; margin-bottom: 10px">
                                <img src=${imgUrl} alt="커뮤니티 사진" style="width: 100%" />
                                <div style="width: 30px; height: 30px; background-color: #222222; border-radius: 50%; position: absolute; top: 15px; right: 15px; color: white; cursor: pointer"
                                    onclick="removeImage(${i})" />
                                    <span style="width: 100%; margin-left: 10px; line-height: 30px">X</span>
                                </div>
                                </div>
                            `
          $("#img-wrap").append(temp)
          imageUrlList.push(response.imgList[i]) // [url]
        }

        // 태그 넣기
        for (let i = 0; i < response.tagList.length; i++) {
          var temp = `
                                <div style="padding: 5px 10px; border-radius: 50px; border: 1px solid #F46B3F; font-size: 12px; font-weight: bold; margin-right: 5px" >
                                ${response.tagList[i].id}
                                </div>
                            `
          $("#tag-select-list").append(temp)
          tags.push(response.tagList[i].id)
        }

        if (response.chatStatus == "Y") {
          $("#flexCheckDefault").prop("checked", true)
          $("#chatCnt-input").val(response.chatMemCnt)
        } else {
          $("#flexCheckDefault").prop("checked", false)
          $("#chatCnt-input").val("")
        }
      },
      error: function (response, status, error) {
        if (response.responseJSON.status == 500) {
          regenerateToken()
          getCommunity()
        }
      },
    })
  }

  async function getImageURL(objectKey) {
    var loadData = ""
    const accessToken = localStorage.getItem("accessToken")
    // 파일을 여러개 선택할 수 있으므로 files 라는 객체에 담긴다.
    console.log("objectKey 이미지 파일이름 찍히는지 보자.")
    console.log("objectKey : ", objectKey)

    await $.ajax({
      type: "GET",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/s3/getPreSignedURL?fileName="
          +
          objectKey,
      contentType: "application/json",
      processData: false,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      data: objectKey,
      xhrFields: {
        withCredentials: false, // 클라이언트와 서버가 통신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
      },
      success: await function (response) {
        console.log("세번째")
        console.log("preSignedURL : ", response)
        loadData = response
      },
      error: function (request, status, error) {
        console.log("에러난다..!")
        console.log(request, status, error)
        // "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr);
      },
    })
    return loadData
  }

  function searchTags() {
    const accessToken = localStorage.getItem("accessToken")
    var tagName = $("#tag-search-input").val()
    $.ajax({
      type: "GET",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/hashtags?offset=0&limit=20&name="
          +
          tagName,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: function (response) {
        console.log("response : ", response)
        $(".tag-select-box").empty()
        for (let i = 0; i < response.data.length; i++) {
          var temp = `
                <li class="item" onclick="addTagList(${response.data[i].id})">${response.data[i].id} : ${response.data[i].name}</li>
              `
          $(".tag-select-box").append(temp)
        }
      },
      error: function (response, status, error) {
        if (response.responseJSON.status == 500) {
          regenerateToken()
          searchTags()
        }
      },
    })
  }

  // 수정하기
  function updateCommunity() {
    const accessToken = localStorage.getItem("accessToken")
    console.log($("#flexCheckDefault").val())
    console.log($("#chatCnt-input").val())

    $.ajax({
      type: "PATCH",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/boards/communities/" +
          communityId,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify({
        title: $("#title").val(),
        contents: $("#contents").val(),
        chatStatus: $("#flexCheckDefault").val(),
        chatMemCnt: $("#chatCnt-input").val(),
        tagList: tags,
        imgList: imageUrlList,
      }),
      success: function (response) {
        updateChat(communityId, $("#chatCnt-input").val())
        alert("수정완료")
        window.location.href = "h-1_communityMain.html"
      },
      error: function (response, status, error) {
        if (response.responseJSON.status == 500) {
          regenerateToken()
          updateCommunity()
        }
      },
    })
  }

  //이미지경로리스트 전역변수 지정.
  var imageUrlList = []
  const imageInput = $("#chooseFile")[0]
  var imgName = ""

  function imgPresignedURL(input) {
    const accessToken = localStorage.getItem("accessToken")
    // 파일을 여러개 선택할 수 있으므로 files 라는 객체에 담긴다.]
    // console.log("input.name 인풋 파일이름 찍히는지 보자.")
    // console.log("input.name : ", imageInput.files[0].name)
    // console.log("$('#chooseFile'): ", $("#chooseFile"))
    // console.log("$('#chooseFile').files: ", $("#chooseFile")[0].files)

    $.ajax({
      type: "POST",
      url: `http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/s3/preSignedURL`,
      // url: `http://localhost:8080/s3/preSignedURL`,
      // dataType: "text",
      enctype: "multipart/form-data",
      // contentType: "application/json; charset=utf-8",
      processData: false,
      contentType: false,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken);
      },
      // data: JSON.stringify({ fileName: imageInput.files[0].name }),
      data: imageInput.files[0].name,

      // xhrFields: {
      //     withCredentials: true, // 클라이언트와 서버가 통4신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
      // },
      success: function (response) {
        console.log("preSignedURL : ", response)
        imageUpload(response)
        imageUrlList.push(response.imageName)
        console.log("imageUrlList : ", imageUrlList)
        // put 으로 이미지 넘기는 함수 실행
      },
      error: function (request, status, error) {
        console.log("에러난다..!")
        console.log(request, status, error)
        // "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr);
      },
    })
  }

  function imageUpload(presignedURLObject) {
    const accessToken = localStorage.getItem("accessToken")
    var file = $("#chooseFile")[0].files[0]

    $.ajax({
      type: "PUT",
      url: presignedURLObject.preSignedURL,
      contentType: 'image/png',
      processData: false,
      // beforeSend: function (xlr) {
      //     xlr.setRequestHeader("Authorization", accessToken)
      // },
      data: file,
      xhrFields: {
        withCredentials: false,  // 클라이언트와 서버가 통신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
      },
      success: function (response) {
        console.log("response : ")
        console.log("이미지 수정완료 : ")

      },
      error: function (request, status, error) {
        console.log("에러난다..!")
        console.log(request, status, error)
        // "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr);
      },
    })
  }

  async function removeImage(index) {
    imageUrlList.splice(index, 1)
    $("#img-wrap").empty()
    for (let i = 0; i < imageUrlList.length; i++) {
      var imgUrl = await getImageURL(imageUrlList[i]);
      var temp = `
                        <div style="width: 300px; height: 185px; overflow: hidden; position: relative; margin-bottom: 10px">
                        <img src=${imgUrl} alt="커뮤니티 사진" style="width: 100%" />
                        <div style="width: 30px; height: 30px; background-color: #222222; border-radius: 50%; position: absolute; top: 15px; right: 15px; color: white; cursor: pointer"
                            onclick="removeImage(${i})"
                        >
                            <span style="width: 100%; margin-left: 10px; line-height: 30px">X</span>
                        </div>
                        </div>
                    `
      $("#img-wrap").append(temp)
    }
  }

  function addTagList(id) {
    for (let i = 0; i < tags.length; i++) {
      if (tags[i] == id) {
        alert("이미 선택했습니다.")
        return
      }
    }
    tags.push(id)
    $("#tag-select-list").empty()
    for (let i = 0; i < tags.length; i++) {
      var temp = `
        <div style="padding: 5px 10px; border-radius: 50px; border: 1px solid #F46B3F; font-size: 12px; font-weight: bold; margin-right: 5px" >
          ${tags[i]}
        </div>
      `
      $("#tag-select-list").append(temp)
    }
  }

  function addTag() {
    const accessToken = localStorage.getItem("accessToken")
    $.ajax({
      type: "POST",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/hashtags?name=" +
          $("#tag-add").val(),
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: function (response) {
        alert("추가 완료")
        $("#tag-add").empty()
        searchTags()
      },
      error: function (response, status, error) {
        if (response.responseJSON.status == 500) {
          regenerateToken()
          addTag(commentId)
        }
      },
    })
  }

  function removeTag() {
    tags = []
    $("#tag-select-list").empty()
  }

  function checkChat() {
  }

  function imgUpload(input) {
    const accessToken = localStorage.getItem("accessToken")

    const imageInput = $("#chooseFile")[0]
    // 파일을 여러개 선택할 수 있으므로 files 라는 객체에 담긴다.
    console.log("$('#chooseFile'): ", $("#chooseFile"))
    console.log("$('#chooseFile').files: ", $("#chooseFile")[0].files)

    var formData = new FormData()
    for (var i = 0; i < imageInput.files.length; i++) {
      // formData.append("image", imageInput.files[i]);
      formData.append("multipartFile", imageInput.files[i])
      console.log("imageInput.files[i].name : ", imageInput.files[i].name)
    }

    $.ajax({
      type: "POST",
      url: `http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/s3/file`,
      // dataType: "json",
      // dataType: "multipart",
      enctype: "multipart/form-data",
      // contentType: "application/json; charset=utf-8",
      processData: false,
      contentType: false,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      data: formData,
      xhrFields: {
        withCredentials: true, // 클라이언트와 서버가 통신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
      },
      success: function (response) {
        $("#img-wrap").empty()
        console.log("response", response)
        for (let i = 0; i < response.length; i++) {
          imageUrlList.push(response[i])
        }

        return imageUrlList
      },
      error: function (response, status, error) {
        if (response.responseJSON.status == 500) {
          regenerateToken()
          imgUpload(input)
        }
      },
    })
  }

  function regenerateToken() {
    var refreshToken = localStorage.getItem("refreshToken")

    $.ajax({
      type: "POST",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/auth/token/regenerate",
      contentType: "application/json; charset=utf-8",
      data: JSON.stringify({
        refreshToken: refreshToken,
      }),
      success: function (response) {
        localStorage.setItem("accessToken", response.accessToken)
        localStorage.setItem("refreshToken", response.refreshToken)
      },
      error: function (response) {
        console.log("에러 : ", response)
      },
    })
  }

  function updateChat(communityId, roomMaxCnt) {
    $.ajax({
      type: "POST",
      url:
          "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/chat/updateRoom?roomId="
          +
          communityId +
          "&roomMaxCnt=" +
          roomMaxCnt,
      success: function () {
        console.log("수정 성공")
      },
    })
  }
  //친구 검색
  function searchFriend() {
    let targetNickname = $("#searchNickName").val();
    const accessToken = localStorage.getItem("accessToken")

    if($("#searchNickName").val()==''){
      alert("닉네임을 입력해주세요.");
      return;
    }

    $.ajax({
      type: "GET",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friend?page=0&size=10&targetNickname=" + targetNickname,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: function (response) {

        $(".friend-list-1").empty();
        $(".friend-list-2").empty();
        $(".friend-list-3").empty();
        $(".line").remove();

        let result = null;

        if(response.data.length==0){
          result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-top: 20px">검색 결과가 없습니다.</p>`

          $(".friend-list-3").append(result);
        }else{
          for (let i = 0; i < response.data.length; i++) {
            let image = response.data[i].friendImage;
            let friendId = response.data[i].friendId;
            let name = response.data[i].friendName;
            let tags = response.data[i].hashtagList;
            let tagName = [];

            for (let j = 0; j < tags.length; j++) {
              tagName.push("#" + tags[j].name);
            }

            result = `
                    <li style="margin-top: 10px;">
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc;">
                            <img className="img" src="${image}"/>
                          </div>
                        </div>
                        <input type="hidden" value="${friendId}">
                          <p className="name" style="margin-left: 10px; margin-top: 2px">${name}</p>
                         <p style="font-size: 11px; color: #FF422F; margin-left: 20px; width : 300px; display: inline-block; padding: 0px; margin-top: 7px; ">${tagName}</p>
                      </li>`


            $(".friend-list-3").append(result);
          }
        }
        $("#searchNickName").val('');
      }
    });
  }

  //추천 친구 리스트
  function recommendFriedList() {
    const accessToken = localStorage.getItem("accessToken")

    $.ajax({
      type: "GET",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends/recommends?page=0&size=5",
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: function (response) {

        let result = null;
        let sideFriend = null;
        let tagName = [];
        $(".friend-list-2").empty();

        if(response.data.length==0){
          result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-bottom: 30px">추천 친구가 없습니다.</p>`

          $(".friend-list-2").append(result);
        }else{
          for (let i = 0; i < response.data.length; i++) {
            let image = response.data[i].friendImage;
            let name = response.data[i].friendName;
            let friendId = response.data[i].friendId;
            let tags = response.data[i].hashtagList;

            tagName = [];
            for (let j = 0; j < tags.length; j++) {
              tagName.push("#" + tags[j].name);
            }

            sideFriend = `<li style="margin-top: 20px">
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc; text-align: center">
                            <img className="img" src="${image}"/>
                          </div>
                        </div>
                        <input class="targetId1" type="hidden" value="${friendId}" id="targetId">
                          <p className="name" style="margin-left: 10px;margin-bottom: 10px" id="targetName">${name}</p>
                           <p style="font-size: 11px; color: #FF422F; margin-left: 20px; display: inline-block; margin-top: 3px; width: 200px">${tagName}</p>
                          <button type="button" class="btn btn-link" onclick="addFriend(${friendId});"
                                        style="text-decoration: none; color: cornflowerblue; font-size: 13px; padding: 0px; margin-left: 10px; margin-bottom: 11px; font-weight: bolder;
                                        width: 70px">친구추가</button>
                      </li>`

            $(".friend-list-2").append(sideFriend);
          }
        }
      },
      error : function (response){
        console.log(response)
      }
    });
  }

  //내 친구 리스트
  function myFriedList() {
    const accessToken = localStorage.getItem("accessToken")

    $.ajax({
      type: "GET",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?page=0&size=5",
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success: function (response) {

        $(".friend-list-1").empty();

        let result = null;
        let tagName = [];

        if (response.data.length == 0) {
          result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-bottom: 30px">추가된 친구가 없습니다.</p>`

          $(".friend-list-1").append(result);

        } else {
          for (let i = 0; i < response.data.length; i++) {
            let image = response.data[i].friendImage;
            let name = response.data[i].friendName;
            let friendId = response.data[i].friendId;
            let tags = response.data[i].hashtagList;

            tagName = [];
            for (let j = 0; j < tags.length; j++) {
              tagName.push("#" + tags[j].name);
            }

            result = `<li>
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc;">
                            <img className="img" src="${image}"/>
                          </div>
                        </div>
                        <input type="hidden" value="${friendId}" id="targetId">
                          <p className="name" style="margin-left: 10px; margin-top: 2px; font-size: 15px">${name}</p>
                          <p style="font-size: 11px; color: #FF422F; margin-left: 20px; display: inline-block; margin-top: 7px; width: 200px">${tagName}</p>
                          <button type="button" class="btn btn-link" onclick="deleteFriend(${friendId});"
                                        style="text-decoration: none; color: #93961E; font-size: 13px; padding: 0px; margin-left: 10px; margin-bottom: 2px; font-weight: bolder;
                                        width: 70px">친구삭제</button>
                      </li>`

            $(".friend-list-1").append(result);
          }
        }
      }
    });
  }

  //친구 추가
  function addFriend(targetId) {
    const accessToken = localStorage.getItem("accessToken")

    $.ajax({
      type: "POST",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?targetId=" + targetId + "&page=0&size=5",
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success : function (){
        $(".friend-list-1").empty();
        $(".friend-list-2").empty();


        let result = `<p class="recommend-title">내 친구목록</p>`;
        let result2 = `<div class="line"></div>
            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>`;

        $(".friend-list-1").append(result);
        $(".friend-list-2").append(result2);

        myFriedList();
        recommendFriedList();
        mainRecommendFriendList()
      }
    });
  }

  function deleteFriend(targetId) {
    const accessToken = localStorage.getItem("accessToken")

    $.ajax({
      type: "DELETE",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?targetId=" + targetId + "&page=0&size=5",
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success : function (){
        $(".friend-list-1").empty();
        $(".friend-list-2").empty();

        let result = `<p class="recommend-title">내 친구목록</p>`;
        let result2 = `<div class="line"></div>
            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>`;

        $(".friend-list-1").append(result);
        $(".friend-list-2").append(result2);

        myFriedList();
        recommendFriedList();
        mainRecommendFriendList()
      }
    });
  }

  //알림 조회
  function selectAlarm(){
    const accessToken = localStorage.getItem("accessToken")
    $.ajax({
      type: "GET",
      contentType: "application/json",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/alarm?page=0&size=10",
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success : function (response){
        $("#alarm").empty();

        let result = null;
        let changeImg = null;

        if(response.data.length==0){
          result =`<li style="color: #f46b3f; margin-left: 50px">※ 현재 알림이 없습니다</li>`;
          $("#alarm").append(result);
        }

        for(var i=0; i<response.data.length; i++){

          board_Id = response.data[i].boardId;
          alarmId = response.data[i].alarmId;
          if(response.data[i].readStatus=="N"){

            $(".icon-bell").empty();

            changeImg = `<img className="img" style="width: 32px; height : 32px" src="./../static/img/icon_bell_2.png"/>`;

            $(".icon-bell").append(changeImg);

            result =`<li><a onclick="setCommunityId(${board_Id}, ${alarmId})" style="color: #f46b3f">${response.data[i].message}</a></li>`;
            $("#alarm").append(result);
          }else{
            result =`<li><a onclick="setCommunityId(${board_Id}, ${alarmId})" style="color: black">${response.data[i].message}</a></li>`;
            $("#alarm").append(result);
          }
        }
      }
    });
  }
  //알람 읽음 상태로 변경
  function updateAlarmStats(alarmId){
    const accessToken = localStorage.getItem("accessToken")
    $.ajax({
      type: "PATCH",
      url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/alarm?alarmId=" + alarmId,
      beforeSend: function (xlr) {
        xlr.setRequestHeader("Authorization", accessToken)
      },
      success : function (response){
        console.log("업데이트 ")
        selectAlarm();
      }
    });
  }
  //로컬 스토리지에 boardId 저장
  function setCommunityId(board_Id, alarmId){
    updateAlarmStats(alarmId);
    localStorage.setItem("communityId", board_Id)
    location.replace('h-2_communityDetail.html');
  }
  function moveMainPage() {
    window.location = "./../index.html"
  }
</script>
</body>
</html>
