<!DOCTYPE html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8" />
        <title>메인페이지</title>
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />

        <link rel="manifest" href="site.webmanifest" />
        <link rel="apple-touch-icon" href="icon.png" />
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="css/normalize.css" />
        <link rel="stylesheet" href="css/main.css" />
        <link rel="stylesheet" href="css/menu.css" />
        <link rel="stylesheet" href="css/reset.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <meta name="theme-color" content="#fafafa" />
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <style>
            .container {
                width: 1200px;
                /*height: 1000px;*/
                padding: 0;
                margin-top: 50px;
                /* background-color: #fffbf4; */
            }

            #recommend,
            #community {
                display: flex;
                flex-wrap: nowrap;
                grid-template-columns: repeat(4, 1fr);
                width: 1200px;
                gap: 20px;
            }
            .post {
                width: 100%;
                cursor: pointer;
            }
            .post .post-img-wrap {
                width: 285px;
                height: 218px;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }
            .post .post-img-wrap img {
                width: 140%;
            }

            .post .post-img-wrap1 {
                width: 285px;
                height: 218px;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }
            .post .post-img-wrap1 img {
                width: 140%;
                vertical-align: middle;
            }

            /* #recommend .post .post-text
            #recommend .post .post-text .title
            #recommend .post .post-text .heart-wrap
            #recommend .post .post-text .heart-wrap .heart-img-wrap */

            .top-area {
                display: flex;
                width: 100%;
                justify-content: space-between;
                margin-bottom: 30px;
            }
            .sider-title {
                font-size: 30px;
                font-weight: bold;
            }
            .post-text {
            }
            .post-text .title {
                margin-top: 10px;
                font-weight: bold;
                margin-bottom: 10px;
            }
            .post-text .count {
                font-size: 12px;
            }

            .heart-wrap {
                display: flex;
            }

            .heart-wrap .heart-img-wrap {
                width: 18px;
                height: 18px;
                margin-right: 5px;
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
            }

            .heart-wrap .heart-img-wrap img {
                width: 100%;
            }

            /* .slick-prev,
            .slick-next {
                background-color: white;
                width: 50px;
                height: 50px;
                margin-top: 100px;
                border: none;
                font-size: 20px;
            } */

            .btn-style,
            .btn-style:active,
            .btn-style:focus {
                background-color: #f46b3f;
                border: 1px solid #f46b3f;
            }

            .btn-style:hover {
                background-color: #e1572b;
                border: 1px solid #e1572b;
            }

            .tag-box {
                margin-top: 50px;
                margin-bottom: 100px;
            }

            .btn-group {
                width: 700px;
                display: flex;
                flex-wrap: wrap;
                margin: 0 auto;
            }
            .btn-group > label {
                border-radius: 0;
                margin: 10px;
                border: 1px solid #f46b3f;
                color: #f46b3f;
            }
            .btn-group > label:hover,
            .btn-check:checked + .btn-outline-primary {
                background-color: #f46b3f;
                border: 1px solid #f46b3f;
            }
        </style>
    </head>

    <body>
    <header class="menu">
        <div class="bg-line"></div>
        <div class="logo-wrap" style="cursor: pointer" onclick="moveMainPage()">
            <img class="img" src="./../static/img/logo_main.png" alt="로고"/>
        </div>
        <div class="item-list">
            <a href="./template/g-1_recommend.html">코스추천</a>
            <a href="./template/h-1_communityMain.html">커뮤니티</a>
            <a href="./template/i-1_shopMain.html">쇼핑몰</a>
            <a href="./template/j-1_noticeMain.html">공지사항</a>
        </div>
        <div class="right"></div>
    </header>
        <main class="container">
            <div class="post-slider">
                <div style="width: 1200px;">
                    <img src="static/img/kakao_error.png" style="width: 100%; margin-bottom: 80px" />
                </div>
                <div class="top-area">
                    <h1 class="sider-title">현재 모집중인 크루</h1>
                    <div style="display: flex; align-items: center">
                        <p style="margin-right: 10px; margin-top: 14px">
                            직접 크루를 만들어보세요!
                        </p>
                        <button
                            type="button"
                            class="btn btn-primary btn-style"
                            onclick="moveCommunityCreate()"
                        >
                            모집글 작성하기
                        </button>
                    </div>
                </div>
                <div id="community" style="display: inline-block">
                    <!-- 커뮤니티 리스트 들어갈 자리 -->
                    <div id="communityList"></div>
                    <div id="roomMemberCnt"></div>
                </div>
            </div>
            <div class="post-slider" style="margin-top: 50px">
                <div class="top-area">
                    <h1 class="sider-title">지금 핫한 등산코스</h1>
                </div>
                <div id="recommend">
                    <!-- 코스추천 리스트 들어갈 자리 -->
                </div>
            </div>
        </main>
        <div
            class="tag-box"
            style="width: 1200px; margin: 0 auto; margin-top: 50px; margin-bottom: 100px"
        >
            <h1 class="sider-title">관심사로 찾는 커뮤니티</h1>
            <div
                class="btn-group"
                role="group"
                aria-label="Basic checkbox toggle button group"
                style="margin-top: 50px"
            ></div>
        </div>
        <!--  <p>Hello world! This is HTML5 Boilerplate.</p>-->

        <script src="js/vendor/modernizr-3.11.2.min.js"></script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>

        <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
        <script>
            let list = [
                { id: 1, name: "주변맛집" },
                { id: 2, name: "등산용품" },
                { id: 3, name: "등산데이트" },
                { id: 4, name: "등산친구" },
                { id: 5, name: "봄산" },
                { id: 6, name: "여름산" },
                { id: 7, name: "가을산" },
                { id: 8, name: "겨울산" },
                { id: 9, name: "안전수칙" },
                { id: 10, name: "산악회" },
                { id: 11, name: "10~20대" },
                { id: 12, name: "30~40대" },
                { id: 13, name: "50~60대" },
                { id: 14, name: "등산꿀팁" },
                { id: 15, name: "산추천" },
                { id: 16, name: "계곡추천" },
                { id: 17, name: "등린이" },
                { id: 18, name: "등산입문자" },
                { id: 19, name: "등산매니아" },
                { id: 20, name: "등산모임" },
                { id: 21, name: "1시간걸리는산" },
                { id: 22, name: "2시간걸리는산" },
                { id: 23, name: "3시간걸리는산" },
            ]
            $(document).ready(function () {
                var accessToken = localStorage.getItem("accessToken")
                console.log("accessToken : ", accessToken)
                // if (accessToken == null) {
                //     console.log("accessToken : ", accessToken)
                //     window.location.href = "./template/b-1_login.html"
                // }
                var kakaoCode = document.location.href.split("?")[1];
                console.log("kakaoCode : ", kakaoCode)
                if(kakaoCode) {
                    callback(kakaoCode);
                }
                for (let i = 0; i < list.length; i++) {
                    var temp = `
                        <input type="checkbox" class="btn-check" id="btncheck${i}" autoComplete="off">
                        <label class="btn btn-outline-primary" for="btncheck${i}" onclick="moveCommunityWithHashtag(${list[i].id})">${list[i].name} </label>
                    `
                    $(".btn-group").append(temp)
                }
                checkLogin();
                getCrewCommunityList()
                getRecommendLikeList()
                myFriedList();
                recommendFriedList();
                selectAlarm();
                getMenuProfile();
                $(".friend-dropbox").hide()
                $(".bell-dropbox").hide()
            })

            function callback(kakaoCode) {

                console.log(kakaoCode+": kakao code");
                var settings = {

                    "url": "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/auth/login/kakao?" + kakaoCode,
                    // "url": "http://localhost:8080/auth/login/kakao?" + kakaoCode,
                    "method": "GET",
                    "timeout": 0,
                };

                $.ajax(settings).done(function (response, status, xhr) {
                    console.log("성공은 해?")
                    // console.log("response : " , response)
                    // console.log("xhr.getResponseHeader('Authorization') : ", xhr.getResponseHeader('Authorization'));
                    // localStorage.setItem('accessToken', xhr.getResponseHeader('Authorization'));
                    // location.href=""
                });
            }

            function checkLogin(){
                const nickname = localStorage.getItem("nickname")
                if(nickname!=null  && nickname != ""){
                    const result = `<div class="friend">
                                <div class="icon-friend" onclick="handleToggleFriendDropBox()">
                                    <img class="img" src="./../static/img/icon_friends.png"/>
                                </div>
                                <div class="friend-dropbox">
                                    <div class="search-area">
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="searchNickName" placeholder="닉네임 검색"
                                                   style="width: 240px; height: 40px">
                                        </div>
                                        <div class="btn-wrap">
                                            <button type="button" class="btn btn-primary search-btn" onclick="searchFriend()"
                                                    style="height: 40px;">검색
                                            </button>
                                        </div>
                                    </div>

                                    <div class="friend-div">
                                        <ul class="friend-list-3"></ul>


                                        <ul class="friend-list-1">
                                            <p class="recommend-title">내 친구목록</p>
                                        </ul>

                                        <div class="line"></div>

                                        <ul class="friend-list-2">
                                            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="bell">
                                <div class="icon-bell" onclick="handleToggleBellDropBox()">
                                    <img class="img" src="./../static/img/icon_bell.png"/>
                                </div>
                                <div class="bell-dropbox">
                                    <p style="margin-bottom: 10px">알람</p>
                                    <ul id="alarm">

                                    </ul>
                                </div>
                            </div>
                            <a id="my-profile" style="display: flex; align-items: center;" class="my-profile-wrap"
                               href="./template/f-1_myPage.html">
                            </a>`;

                    $(".right").append(result);
                }else{
                    const result = `<div class="my-profile-wrap" onclick="moveLoginPage()">
                                    <div class="img-wrap">
                                        <img class="img" src="./../static/img/icon_profile_default.png " />
                                    </div>
                                    <p class="text">로그인 해주세요</p>
                                </div>`

                    $(".right").append(result);
                }
            }

            async function getMenuProfile() {
                var menuProfile = JSON.parse(localStorage.getItem("menuProfile"))
                const nickname = localStorage.getItem("nickname")
                var imgUrl = "";
                if (menuProfile.profileImage){
                    imgUrl = await getImageURL(menuProfile.profileImage);
                }else{
                    imgUrl = "./static/img/icon_profile_default.png"
                }
                var tempProfile = `
                    <div class="img-wrap" style="width: 40px; height: 40px;">
                        <img class="img" style="height: 100%; width: auto" src=${imgUrl} alt="프로필사진"/>
                    </div>
                    <p class="text" style="margin-bottom: 20px">${nickname}님</p>
                `
                $("#my-profile").append(tempProfile)
            }

            function handleToggleBellDropBox() {
                $(".bell-dropbox").toggle()
                $(".friend-dropbox").hide()
            }

            function handleToggleFriendDropBox() {
                $(".friend-dropbox").toggle();
                $(".bell-dropbox").hide();

                //사람버튼 클릭 시 기존 데이터 reload 되도록
                $(".friend-div").empty();

                let result = `<ul class="friend-list-3"></ul>
                              <ul class="friend-list-1">
                                <p class="recommend-title">내 친구목록</p>
                              </ul>

                              <div class="line"></div>

                              <ul class="friend-list-2">
                                <p class="recommend-title" style="margin-top: 10px">추천 친구</p>
                              </ul>`

                $(".friend-div").append(result);
                myFriedList();
                recommendFriedList();
            }

            async function getCrewCommunityList() {
                $.ajax({
                    type: "GET",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/boards/communities?page=0&size=4&title=&contents&nickname&hashtagId=0&chatStatus=Y&sort=likeDesc",
                    //url: "http://localhost:8080/boards/communities?page=0&size=4&title=&contents&nickname&hashtagId=0&chatStatus=Y&sort=likeDesc",
                    // beforeSend: function (xlr) {
                    //     xlr.setRequestHeader("Authorization", accessToken)
                    // },
                    success: async function (response) {

                        console.log("크루 :", response)

                        for (let i = 0; i < response.data.length; i++) {

                            var imgUrl = ""
                            if (response.data[i].imgList[0]) {
                                imgUrl = await getImageURL(response.data[i].imgList[0])
                            } else {
                                imgUrl = "./../static/img/mountain-default.png"
                            }

                            var temp = `
                            <div class="post" onclick="moveCommunityDetail(${response.data[i].boardId})" style="display: inline-block; width: 230px; margin-right: 66px">
                                <div class="post-img-wrap1">
                                    <img src=${imgUrl} alt="산 이미지">
                                </div>
                                <div class="post-text-title">
                                    <p class="title">${response.data[i].title}</p>
                                </div>
                            </div>
                            `

                            $("#communityList").append(temp);
                            roomMemberCnt(response.data[i].boardId);
                        }
                    },
                    error: function (response) {
                        console.log("response : ", response)
                        if (response.responseJSON.status == 500) {
                            regenerateToken()
                        }
                    },
                })
            }

            async function getRecommendLikeList() {
                const accessToken = localStorage.getItem("accessToken")
                console.log("진행중")
                $.ajax({
                    type: "GET",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/boards/recommends?page=0&size=4&score=0&season=&altitude=0&region=&sort=likeDesc",
                    // url: "http://localhost:8080/boards/recommends?page=0&size=4&score=0&season=&altitude=0&region=&sort=likeDesc",
                    // beforeSend: function (xlr) {
                    //     xlr.setRequestHeader("Authorization", accessToken)
                    // },
                    success: async function (response) {
                        console.log("코스추천 response : ", response)

                        $("#recommend").empty()

                        for (let i = 0; i < response.data.length; i++) {
                            var imgUrl = ""
                            if (response.data[i].imgList[0]) {
                                imgUrl = await getImageURL(response.data[i].imgList[0])
                            } else {
                                imgUrl = "./../static/img/mountain-default.png"
                            }
                            var temp = `
                                <div class="post" onclick="moveRecommendDetail(${response.data[i].boardId})">
                                    <div class="post-img-wrap">
                                        <img src=${imgUrl} alt="산 이미지" />
                                    </div>
                                    <div class="recommend-text">
                                        <p class="title">${response.data[i].title}</p>
                                        <div class="heart-wrap">
                                            <div class="heart-img-wrap">
                                                <img src="static/img/heart.png" alt="좋아요 하트" />
                                            </div>
                                            <p style="margin-bottom: 0; font-size: 14px">${response.data[i].likeCount}</p>
                                        </div>
                                    </div>
                                </div>
                            `
                            $("#recommend").append(temp)
                        }
                    },
                    error: function (error) {
                        if (response.responseJSON.status == 500) {
                            regenerateToken()
                        }
                    },
                })
            }

            async function getImageURL(objectKey) {
                var loadData = ""
                const accessToken = localStorage.getItem("accessToken")
                await $.ajax({
                    type: "GET",
                    url:
                        "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/s3/getPreSignedURL?fileName=" +
                        objectKey,
                    contentType: "application/json",
                    processData: false,
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    data: objectKey,
                    xhrFields: {
                        withCredentials: false, // 클라이언트와 서버가 통신할때 쿠키와 같은 인증 정보 값을 공유하겠다는 설정
                    },
                    success: await function (response) {
                        loadData = response
                    },
                    error: function (request, status, error) {
                        console.log("에러난다..!")
                        console.log(request, status, error)
                        if (response.responseJSON.status == 500) {
                            regenerateToken()
                        }
                        // "[requestPostBodyJson] : [error] : " + JSON.stringify(xhr);
                    },
                })
                return loadData
            }

            function moveCommunityWithHashtag(id) {
                localStorage.setItem("hashtagId", id)
                window.location = "template/h-1_communityMain.html"
            }

            function moveCommunityDetail(id) {
                const accessToken = localStorage.getItem("accessToken")
                if (accessToken == "" || accessToken == null) {
                    alert("로그인 한 이용자만 확인할 수 있습니다.")
                } else {
                    localStorage.setItem("communityId", id)
                    window.location = "template/h-2_communityDetail.html"
                }
            }

            function moveRecommendDetail(id) {
                const accessToken = localStorage.getItem("accessToken")
                if (accessToken == "" || accessToken == null) {
                    alert("로그인 한 이용자만 확인할 수 있습니다.")
                } else {
                    localStorage.setItem("recommendId", id)
                    window.location = "template/g-2_recommendDetail.html"
                }
            }

            function regenerateToken() {
                var refreshToken = localStorage.getItem("refreshToken")
                console.log("refreshToken : ", refreshToken)
                $.ajax({
                    type: "POST",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/auth/token/regenerate",
                    // url: "http://localhost:8080/auth/token/regenerate",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        refreshToken: refreshToken,
                    }),
                    success: function (response) {
                        localStorage.setItem("accessToken", response.accessToken)
                        localStorage.setItem("refreshToken", response.refreshToken)
                        getCrewCommunityList()
                        getRecommendLikeList()
                    },
                    error: function (response) {
                        console.log("response : ", response)
                        alert("토큰 만료되었습니다. 로그인 페이지로 이동합니다.")
                        window.location.href = "./template/b-1_login.html"
                    },
                })
            }

            function moveCommunityCreate() {
                var accessToken = localStorage.getItem("accessToken")
                console.log("accessToken?? : ", accessToken)
                if (accessToken == "" || accessToken == null) {
                    alert("로그인 한 이용자만 확인할 수 있습니다.")
                } else {
                    window.location = "./template/h-3_communityCreate.html"
                }
            }

            //친구 검색
            function searchFriend() {
                let targetNickname = $("#searchNickName").val();
                const accessToken = localStorage.getItem("accessToken")

                if($("#searchNickName").val()==''){
                    alert("닉네임을 입력해주세요.");
                    return;
                }

                $.ajax({
                    type: "GET",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friend?page=0&size=10&targetNickname=" + targetNickname,
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success: async function (response) {

                        $(".friend-list-1").empty();
                        $(".friend-list-2").empty();
                        $(".friend-list-3").empty();
                        $(".line").remove();

                        let result = null;

                        if(response.data.length==0){
                            result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-top: 20px">검색 결과가 없습니다.</p>`

                            $(".friend-list-3").append(result);
                        }else{
                            for (let i = 0; i < response.data.length; i++) {
                                let friendId = response.data[i].friendId;
                                let name = response.data[i].friendName;
                                let tags = response.data[i].hashtagList;
                                let tagName = [];

                                var imgUrl = "";
                                console.log("response.data[i].friendImage : ", response.data[i])
                                if (response.data[i].friendImage){
                                    imgUrl = await getImageURL(response.data[i].friendImage);
                                }else{
                                    imgUrl = "./static/img/icon_profile_default.png"
                                }



                                for (let j = 0; j < tags.length; j++) {
                                    tagName.push("#" + tags[j].name);
                                }

                                result = `
                    <li style="margin-top: 10px;">
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc;">
                            <img className="img" src="${imgUrl}"/>
                          </div>
                        </div>
                        <input type="hidden" value="${friendId}">
                          <p className="name" style="margin-left: 10px; margin-top: 2px">${name}</p>
                         <p style="font-size: 11px; color: #FF422F; margin-left: 20px; width : 300px; display: inline-block; padding: 0px; margin-top: 7px; ">${tagName}</p>
                      </li>`


                                $(".friend-list-3").append(result);
                            }
                        }
                        $("#searchNickName").val('');
                    }
                });
            }

            //추천 친구 리스트
            function recommendFriedList() {
                const accessToken = localStorage.getItem("accessToken")

                $.ajax({
                    type: "GET",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends/recommends?page=0&size=5",
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success: async function (response) {

                        let result = null;
                        let sideFriend = null;
                        let tagName = [];
                        $(".friend-list-2").empty();

                        if(response.data.length==0){
                            result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-bottom: 30px">추천 친구가 없습니다.</p>`

                            $(".friend-list-2").append(result);
                        }else{
                            for (let i = 0; i < response.data.length; i++) {
                                let name = response.data[i].friendName;
                                let friendId = response.data[i].friendId;
                                let tags = response.data[i].hashtagList;


                                var imgUrl = "";
                                console.log("response.data[i].friendImage : ", response.data[i])
                                if (response.data[i].friendImage){
                                    imgUrl = await getImageURL(response.data[i].friendImage);
                                }else{
                                    imgUrl = "./static/img/icon_profile_default.png"
                                }


                                tagName = [];
                                for (let j = 0; j < tags.length; j++) {
                                    tagName.push("#" + tags[j].name);
                                }

                                sideFriend = `<li style="margin-top: 20px">
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc; text-align: center">
                            <img className="img" src="${imgUrl}"/>
                          </div>
                        </div>
                        <input class="targetId1" type="hidden" value="${friendId}" id="targetId">
                          <p className="name" style="margin-left: 10px;margin-bottom: 10px" id="targetName">${name}</p>
                           <p style="font-size: 11px; color: #FF422F; margin-left: 20px; display: inline-block; margin-top: 3px; width: 200px">${tagName}</p>
                          <button type="button" class="btn btn-link" onclick="addFriend(${friendId});"
                                        style="text-decoration: none; color: cornflowerblue; font-size: 13px; padding: 0px; margin-left: 10px; margin-bottom: 11px; font-weight: bolder;
                                        width: 70px">친구추가</button>
                      </li>`

                                $(".friend-list-2").append(sideFriend);
                            }
                        }
                    },
                    error : function (response){
                        console.log(response)
                    }
                });
            }

            //내 친구 리스트
            function myFriedList() {
                const accessToken = localStorage.getItem("accessToken")

                $.ajax({
                    type: "GET",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?page=0&size=5",
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success: async function (response) {

                        $(".friend-list-1").empty();

                        let result = null;
                        let tagName = [];

                        if (response.data.length == 0) {
                            result = `<p style="font-size: 12px; color: #FF422F; text-align: center; margin-bottom: 30px">추가된 친구가 없습니다.</p>`

                            $(".friend-list-1").append(result);

                        } else {
                            for (let i = 0; i < response.data.length; i++) {
                                let name = response.data[i].friendName;
                                let friendId = response.data[i].friendId;
                                let tags = response.data[i].hashtagList;

                                var imgUrl = "";
                                console.log("response.data[i].friendImage : ", response.data[i])
                                if (response.data[i].friendImage){
                                    imgUrl = await getImageURL(response.data[i].friendImage);
                                }else{
                                    imgUrl = "./static/img/icon_profile_default.png"
                                }

                                tagName = [];
                                for (let j = 0; j < tags.length; j++) {
                                    tagName.push("#" + tags[j].name);
                                }

                                result = `<li>
                        <div className="left">
                          <div className="img-wrap" style="width: 32px;height: 32px;overflow: hidden; border-radius: 100%; display: flex; justify-content: center; border: 1px solid #cccccc;">
                            <img className="img" src="${imgUrl}"/>
                          </div>
                        </div>
                        <input type="hidden" value="${friendId}" id="targetId">
                          <p className="name" style="margin-left: 10px; margin-top: 2px; font-size: 15px">${name}</p>
                          <p style="font-size: 11px; color: #FF422F; margin-left: 20px; display: inline-block; margin-top: 7px; width: 200px">${tagName}</p>
                          <button type="button" class="btn btn-link" onclick="deleteFriend(${friendId});"
                                        style="text-decoration: none; color: #93961E; font-size: 13px; padding: 0px; margin-left: 10px; margin-bottom: 2px; font-weight: bolder;
                                        width: 70px">친구삭제</button>
                      </li>`

                                $(".friend-list-1").append(result);
                            }
                        }
                    }
                });
            }

            //친구 추가
            function addFriend(targetId) {
                const accessToken = localStorage.getItem("accessToken")

                $.ajax({
                    type: "POST",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?targetId=" + targetId + "&page=0&size=5",
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success : function (){
                        $(".friend-list-1").empty();
                        $(".friend-list-2").empty();


                        let result = `<p class="recommend-title">내 친구목록</p>`;
                        let result2 = `<div class="line"></div>
            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>`;

                        $(".friend-list-1").append(result);
                        $(".friend-list-2").append(result2);

                        myFriedList();
                        recommendFriedList();
                        mainRecommendFriendList()
                    }
                });
            }

            function deleteFriend(targetId) {
                const accessToken = localStorage.getItem("accessToken")

                $.ajax({
                    type: "DELETE",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/friends?targetId=" + targetId + "&page=0&size=5",
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success : function (){
                        $(".friend-list-1").empty();
                        $(".friend-list-2").empty();

                        let result = `<p class="recommend-title">내 친구목록</p>`;
                        let result2 = `<div class="line"></div>
            <p class="recommend-title" style="margin-top: 10px">추천 친구</p>`;

                        $(".friend-list-1").append(result);
                        $(".friend-list-2").append(result2);

                        myFriedList();
                        recommendFriedList();
                        mainRecommendFriendList()
                    }
                });
            }

            //알림 조회
            function selectAlarm(){
                const accessToken = localStorage.getItem("accessToken")
                $.ajax({
                    type: "GET",
                    contentType: "application/json",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/alarm?page=0&size=10",
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success : function (response){
                        $("#alarm").empty();

                        let result = null;
                        let changeImg = null;

                        if(response.data.length==0){
                            result =`<li style="color: #f46b3f; margin-left: 50px">※ 현재 알림이 없습니다</li>`;
                            $("#alarm").append(result);
                        }

                        for(var i=0; i<response.data.length; i++){


                            console.log(response)
                            board_Id = response.data[i].boardId;
                            alarmId = response.data[i].alarmId;
                            if(response.data[i].readStatus=="N"){

                                $(".icon-bell").empty();

                                changeImg = `<img className="img" style="width: 32px; height : 32px" src="./../static/img/icon_bell_2.png"/>`;

                                $(".icon-bell").append(changeImg);

                                result =`<li><a onclick="setCommunityId(${board_Id}, ${alarmId})" style="color: #f46b3f; cursor: pointer">${response.data[i].message}</a></li>`;
                                $("#alarm").append(result);
                            }else{
                                result =`<li><a onclick="setCommunityId(${board_Id}, ${alarmId})" style="color: #D2D2D2; cursor: pointer">${response.data[i].message}</a></li>`;
                                $("#alarm").append(result);
                            }
                        }
                    }
                });
            }
            //알람 읽음 상태로 변경
            function updateAlarmStats(alarmId){
                const accessToken = localStorage.getItem("accessToken")
                $.ajax({
                    type: "PATCH",
                    url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/alarm?alarmId=" + alarmId,
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success : function (){
                        console.log("업데이트 ")
                        selectAlarm();
                    }
                });
            }
            function setCommunityId(board_Id, alarmId){
                updateAlarmStats(alarmId);
                localStorage.setItem("communityId", board_Id)
                location.replace('./template/h-2_communityDetail.html');
            }
            function roomMemberCnt(communityId) {

                const accessToken = localStorage.getItem("accessToken")
                $.ajax({
                    type: "GET",
                     url: "http://ec2-3-36-247-109.ap-northeast-2.compute.amazonaws.com:8080/chat/room?roomId="
                     //url : "http://localhost:8080/chat/room?roomId="
                        + communityId,
                    beforeSend: function (xlr) {
                        xlr.setRequestHeader("Authorization", accessToken)
                    },
                    success: function (response) {

                        let crew = `<div style="width: 300px; display: inline-block">크루 참여 인원 수 : <sapn style="color : #f46b3f"> ${response.userCount} </sapn> / <sapn>${response.maxUserCnt}</sapn></div>`;

                        $("#roomMemberCnt").append(crew);
                    }
                })
            }
            function moveMainPage() {
                window.location = "index.html"
            }
            function moveLoginPage(){
                window.location.href = "./template/b-1_login.html"
            }
        </script>
    </body>
</html>
